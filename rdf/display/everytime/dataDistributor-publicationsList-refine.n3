#
# ------------------------------------------------------------------------------
#
# ------------------------------------------------------------------------------
# 
# 

@prefix : <http://vitro.mannlib.cornell.edu/ns/vitro/ApplicationSetup#> .

:lpub_r_distributor
    a   <java:edu.cornell.library.scholars.webapp.controller.api.distribute.DataDistributor> ,
        <java:edu.cornell.library.scholars.webapp.controller.api.distribute.decorator.JavaScriptTransformDistributor> ;
    :actionName "listPublications-refine" ;
    :contentType "application/json" ;
    :child :lpub_r_inner ;
    :supportingScript "/js/scholars-vis/rdflib.js";
    :supportingScript "/js/scholars-vis/rdf-helper-methods.js";
    :script """
        function transform(turtleRdf) {
            var graph = populateGraph(turtleRdf);
            
            var results = [];
            getPubStatements().forEach(processPublication);
            
            return JSON.stringify(results, null, 2);
                
            function processPublication(stmt) {
                var pubNode = stmt.subject;
 
                var result = { uri: pubNode.uri };
                addRequiredField(result, "label", findPublicationName);
                addRequiredField(result, "authors", findAuthors);
                addOptionalField(result, "pubDate", findPubDate);
                addOptionalField(result, "journalName", findJournalName);
                addOptionalField(result, "doi", findDoi);
                results.push(result);
                    
                function findPublicationName() {
                    return getAnyValue(graph, pubNode, RDFS('label'));
                }
                    
                function findAuthors() {
                    return graph.each(pubNode, VIVO('relatedBy')).map(findAuthorInfo).sort(rankSorter);
                        
                    function findAuthorInfo(authorshipNode) {
                        return {
                            rank: parseInt(getAnyValue(graph, authorshipNode, VIVO('rank'))),
                            label: getAnyValue(graph, authorshipNode, VIVO('relates'), RDFS('label'))
                        };
                    }
                        
                    function rankSorter(a, b) {
                        return a.rank - b.rank;
                    }
                }
                
                function findPubDate() {
                    return getAnyValue(graph, pubNode, VIVO('dateTimeValue'), VIVO('dateTime')).substring(0, 4);
                }
                
                function findJournalName() {
                    return getAnyValue(graph, pubNode, VIVO('hasPublicationVenue'), RDFS('label'));
                }
                
                function findDoi() {
                    return getAnyValue(graph, pubNode, BIBO('doi'));
                }
            }
                
            function getPubStatements() {
                return graph.statementsMatching(undefined, RDF('type'), BIBO('Document'));
            }
        }
    """ .

:lpub_r_inner
    a   <java:edu.cornell.library.scholars.webapp.controller.api.distribute.DataDistributor> ,
        <java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.RdfGraphDistributor> ;
    :actionName "_none_" ;
    :graphBuilder :lpub_r_gb .
    
:lpub_r_gb
    a   <java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.GraphBuilder> ,
        <java:edu.cornell.library.scholars.webapp.controller.api.distribute.rdf.graphbuilder.ConstructQueryGraphBuilder> ;
    :uriBinding "person" ;
    :constructQuery """
        PREFIX rdf:      <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
        PREFIX rdfs:     <http://www.w3.org/2000/01/rdf-schema#>
        PREFIX bibo:     <http://purl.org/ontology/bibo/>
        PREFIX foaf:     <http://xmlns.com/foaf/0.1/>
        PREFIX vivo:     <http://vivoweb.org/ontology/core#>
        CONSTRUCT {
          ?pub a bibo:Document .
          ?pub rdfs:label ?pubLabel .

          ?pub vivo:relatedBy ?auth2 .
          ?auth2 vivo:rank ?rank .
          ?auth2 vivo:relates ?author .
          ?author rdfs:label ?authorName .

          ?pub vivo:dateTimeValue ?timeStamp .
          ?timeStamp vivo:dateTime ?dateTime .

          ?pub vivo:hasPublicationVenue ?journal .
          ?journal rdfs:label ?journalName .

          ?pub bibo:doi ?doi .
        }
        WHERE
        {
          ?person vivo:relatedBy ?auth .
          ?auth a vivo:Authorship .
          ?auth vivo:relates ?pub .
          ?pub a bibo:Document .
          
          ?pub rdfs:label ?pubLabel .

          ?pub vivo:relatedBy ?auth2 .
          ?auth2 a vivo:Authorship .
          ?auth2 vivo:rank ?rank .
          ?auth2 vivo:relates ?author .
          ?author a foaf:Person .
          ?author rdfs:label ?authorName .

          OPTIONAL {
              ?pub vivo:dateTimeValue ?timeStamp .
              ?timeStamp vivo:dateTime ?dateTime .
          }
          OPTIONAL {
              ?pub vivo:hasPublicationVenue ?journal .
              ?journal rdfs:label ?journalName .
          }
          OPTIONAL {
              ?pub bibo:doi ?doi .
          }
        }
    """ .
